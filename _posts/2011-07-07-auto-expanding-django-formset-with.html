---
layout: post
title: Auto-expanding django formset with jQuery
date: '2011-07-07T23:02:00.009Z'
author: Tim Abell
tags:
- howto
- dhtml
- django
- code
- jQuery
modified_time: '2011-07-08T23:00:55.354Z'
blogger_id: tag:blogger.com,1999:blog-5082828566240519947.post-1390054549969590161
blogger_orig_url: https://timwise.blogspot.com/2011/07/auto-expanding-django-formset-with.html
---

As it took me quite a while to get it how I like it, here's the relevant bits for making a django formset (custom markup in a table), that automatically adds rows (formset forms) client-side / in the browser keeping up as you fill in the form.<br /><br />Do with the code as you wish, no licence needed.<br /><br />In the view (.html file server side) I have:<br /><br /><pre><code>@login_required<br />def invoiceEdit(request, invoice_id):<br />    ...<br />    InlineInvoiceItemsFormSet = inlineformset_factory(Invoice, InvoiceItem, form=DeleteIfEmptyModelForm, formset=DeleteIfEmptyInlineFormSet, can_delete=True, extra=10)<br />    ...<br />    itemFormSet = InlineInvoiceItemsFormSet()<br />    ...<br />    return render_to_response('foo/edit.html', {'invoiceForm': invoiceForm, 'itemFormSet': itemFormSet, 'invoice': invoice}, context_instance=RequestContext(request))</code></pre><br /><br />In the template I have:<br /><br /><pre><code>&lt;script type="text/javascript"><br /> $(function() {<br />  setupInvoiceFormset();<br /> });<br /><br /> var initialRows;<br /><br /> function setupInvoiceFormset() {<br />  initialRows = parseInt($('#id_invoiceitem_set-INITIAL_FORMS').val());<br />  // remove all but last two empty rows<br />  resizeInvoiceFormset();<br />  // add handlers to all inputs to automate row adding<br />  $('.invoiceItemRow :input').blur(resizeInvoiceFormset);<br /> }<br /><br /> const targetExtra = 2; // number of extra rows desired<br /><br /> function resizeInvoiceFormset() {<br />  // count the blank rows at the end<br />  var rows = $('.invoiceItemRow').filter(':not(#templateItemRow)');<br />  var totalRows = rows.length<br />  var blankRows = countBlankRows(rows);<br />  var targetRowCount = totalRows - blankRows + targetExtra;<br />  targetRowCount = Math.max(targetRowCount,initialRows); // don't trim off real rows otherwise delete breaks<br />  if (totalRows > targetRowCount) {<br />   // if there too many blank rows remove the extra rows<br />   rows.slice(targetRowCount).remove(); // negative to strip from ends<br />  } else if (totalRows &lt; targetRowCount) {<br />   // add new blank rows to bring the total up to the desired number<br />   for (var newRowIndex = totalRows; newRowIndex &lt; targetRowCount; newRowIndex++) {<br />    addRow(newRowIndex);<br />   }<br />  } else {<br />   return;<br />  }<br />  // update the hidden form with the new form count<br />  $('#id_invoiceitem_set-TOTAL_FORMS').val(targetRowCount);<br /> }<br /><br /> function countBlankRows(rows) {<br />  // count the empty rows from the bottom up, stopping at the first non-blank row<br />  var blankRows = 0;<br />  for (var i = rows.length -1; i>=0; i--) {<br />   if (isEmptyRow(rows[i])) {<br />    blankRows++;<br />   } else {<br />    break;<br />   }<br />  }<br />  return blankRows;<br /> }<br /><br /> function isEmptyRow(row) {<br />  // loop through all the inputs in the row, return true if they are all blank<br />  // whitespace is ignored<br />  var inputs = $(row).find(':input').filter(':not(:hidden)');<br />  for (var j = 0; j &lt; inputs.length; j++) {<br />   if ($.trim(inputs[j].value).length) {<br />    return false;<br />   }<br />  }<br />  return true;<br /> }<br /><br /> function addRow(newRowIndex) {<br />  var newRow = $('#templateItemRow').clone(true);<br />  newRow.addClass('invoiceItemRow');<br />  newRow.removeAttr('id'); //prevent duplicated template row id<br />  newRow.show();<br />  // replace placeholder with row index<br />  newRow.find(':input').each(function() {<br />   $(this).attr("name", $(this).attr("name").replace('__prefix__', newRowIndex));<br />   $(this).attr("id", $(this).attr("id").replace('__prefix__', newRowIndex));<br />  });<br />  $('.invoiceItemRow:last').after(newRow);<br /> }<br />&lt;/script><br />...<br />{{ "{{" }} itemFormSet.management_form }}<br />&lt;tr id="templateItemRow" class="invoiceItemRow" style="display: none;"><br /> &lt;td>&lt;strong>Item:&lt;/strong>&lt;/td><br /> &lt;td><br />  {{ "{{" }} itemFormSet.empty_form.id }}<br />  {{ "{{" }} itemFormSet.empty_form.description }}<br />  {{ "{{" }} itemFormSet.empty_form.description.errors }}&lt;/td><br /> &lt;td class="price">£{{ "{{" }} itemFormSet.empty_form.price }} {{ "{{" }} itemFormSet.empty_form.price.errors }}&lt;/td>&lt;/tr><br />{{ "{%" }} for item in itemFormSet.forms %}<br />&lt;tr class="invoiceItemRow"><br /> &lt;td>&lt;strong>Item:&lt;/strong>&lt;/td><br /> &lt;td><br />  {{ "{{" }} item.id }}<br />  {{ "{{" }} item.description }}<br />  {{ "{{" }} item.description.errors }}&lt;/td><br /> &lt;td class="price">£{{ "{{" }} item.price }} {{ "{{" }} item.price.errors }}&lt;/td>&lt;/tr><br />{{ "{%" }} endfor %}<br />...</code></pre><br /><br />The result is a form that intuitively shrinks/grows as the content is added/removed.<br /><br />The javascript is of course actually in a separate .js file.<br /><br />References:<br /><ul><li><a href="https://docs.djangoproject.com/en/dev/topics/forms/formsets/">https://docs.djangoproject.com/en/dev/topics/forms/formsets/</a></li><li><a href="http://api.jquery.com/">http://api.jquery.com/</a></li></ul><br /><br />Footnote. You may have noticed the delete-if-empty customisation which I like for usability. References for this at<br /><ul><li><a href="http://pastebin.com/f40a3bde9">http://pastebin.com/f40a3bde9</a></li><li><a href="http://groups.google.com/group/django-users/browse_thread/thread/9e26cf3ab1d1fcb1?tvc=2">http://groups.google.com/group/django-users/browse_thread/thread/9e26cf3ab1d1fcb1?tvc=2</a></li><li><a href="http://groups.google.com/group/django-users/browse_thread/thread/23539f5e085e62b0">http://groups.google.com/group/django-users/browse_thread/thread/23539f5e085e62b0</a></li></ul>