---
layout: post
title: Subversion to git - the pain retold
date: '2012-12-05T00:33:00.000Z'
author: Tim Abell
tags: 
modified_time: '2012-12-05T00:33:51.154Z'
blogger_id: tag:blogger.com,1999:blog-5082828566240519947.post-8381628268559719103
blogger_orig_url: https://timwise.blogspot.com/2012/12/subversion-to-git-pain-retold.html
---

I've spent a week reminding myself why svn sucks.<br /><br />I've been using the <a href="http://freetts.sourceforge.net/">freetts</a> library for speech synth in the <a href="http://communication-book.wikispaces.com/">communication book</a> program I've been working on, and have tripped over a bug in freetts running under openJdk. The freetts source code lives in a svn repository on sourceforge. The first step in troubleshooting is to build the library from source. In order to track any local experimentation / fixes I need to have some kind of local source control, and svn sucks too much to provide this. The obvious next step is to pull the sources down with git-svn (or svn2git as github recommends).<br /><br />After a couple of aborted attempts I was reminded how the loosely defined structure of a svn repository and the over-generalization of tags &amp; branches allows for a complete mess, which then is a pain to import cleanly.<br /><br /><blockquote class="tr_bq">"And they want to make snapshots of smaller subdirectories of the filesystem. After all, it's not so easy to remember that release 1.0 of a piece of software is a particular subdirectory of revision 4822." &nbsp;-- &nbsp; <b>Argh!</b> Terrible "feature", if you're using this feature then <i>you're doing source control wrong</i>! (Quote taken from&nbsp;<a href="http://svnbook.red-bean.com/en/1.7/svn.branchmerge.tags.html" style="color: #3465a4;">http://svnbook.red-bean.com/en/1.7/svn.branchmerge.tags.html</a>&nbsp;)</blockquote><br /><div>I could just grab a tarball and start from there, however there is new code upstream since their last release (v1.2.2), and that means testing two branches, and possibly investigating diffs. In addition if I'm going to make the effort to import the history, I ought to do it well enough first time that others can build on it. It's much harder to correct a bad scm import once work is continued, especially in the distributed world of open source.<br /><br />And so, for my sins, I set about importing the history, and hacking away at it with the excellent tools git provides to turn it into something that actually linked together correctly and didn't make me feel ill by including CVSROOT all over the place (yes, it's not the first migration this project's been through).<br /><br />On the plus side, it is fantastic that the open source license gives a user of a library such as myself the right to go ahead and do something like this and to share the improvement with the world, regardless of whether it's something the original creators / maintainers would have done.<br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://www.flickr.com/photos/tim_abell/8160450028/"><img border="0" src="https://farm8.staticflickr.com/7271/8160450028_af1097a2f7_n.jpg" /></a></div><div style="text-align: center;"><br /></div><br />The layout of the FreeTTS svn repo is not consistent in directory structure, which means the svn import tools don't behave quite as one might expect. This is the inevitable downside to subversions poor choice of architecture around "everything's just a directory structure". (Bitter? Me? Never!)</div><div><br />Here's a taster of how inconsistent the layout is and what a challenge is ahead tidying it up:<br /><br /><a href="http://www.blogger.com/tim@atom:~/repo/freetts.svn$" style="color: #3465a4;">tim@atom:~/repo/freetts.svn$</a> ls */*<br /><span style="font-family: Courier New, Courier, monospace;">branches/release:<br />FreeTTS<br /><br />tags/freetts:<br />FreeTTS<br /><br />tags/pre-rel1-1:<br />FreeTTS<br /><br />tags/rel_1_0_5:<br />CVSROOT  FreeTTS<br /><br />tags/rel1_1_0:<br />FreeTTS<br /><br />tags/rel1_1_2:<br />FreeTTS<br /><br />tags/rel1_2_0:<br />CVSROOT  FreeTTS<br /><br />tags/rel1_2_1:<br />FreeTTS<br /><br />tags/rel1_2_2:<br />acknowledgments.txt  build.xml demo.xml  index.html  license.terms  overview.html  RELEASE_NOTES  speech.properties  tests<br />ANNOUNCE.txt      demo docs   lib       mbrola      README.txt     rtp     src        tools<br /><br />tags/rel_1_2_beta:<br />FreeTTS<br /><br />tags/rel1_2beta2:<br />CVSROOT  FreeTTS<br /><br />tags/start:<br />FreeTTS<br /><br />tags/sun:<br />FreeTTS<br /><br />trunk/CVSROOT:<br />checkoutlist  commitinfo  config  cvsignore  cvswrappers  editinfo  loginfo  modules  notify  rcsinfo  syncmail  taginfo  verifymsg<br /><br />trunk/FreeTTS:<br />acknowledgments.txt  build.xml demo.xml  index.html  license.terms  overview.html  RELEASE_NOTES  speech.properties  tools<br />ANNOUNCE.txt      demo docs   lib       mbrola      README.txt     rtp     src        unittests</span><br /><br />It took all my git-fu powers to sort out this mess. Below is a time shortened sequence of how it was done, just in case I have the misfortune to need to do it again. I ended up abandoning all the ancient tags as they were going to be more effort than I liked to fix, and they could be added retrospectively if anyone really cared. It took me many attempts to get to the below, and this is what I've reconstructed from my fragmented history, hopefully it will provide enough clues should you wish to do similar.<br /><br /><br />FreeTTS project urls: Project front page&nbsp;<a href="http://freetts.sourceforge.net/" style="color: #3465a4;">http://freetts.sourceforge.net/</a>&nbsp;, project site&nbsp;<a href="http://sourceforge.net/projects/freetts/" style="color: #3465a4;">http://sourceforge.net/projects/freetts/</a>&nbsp;, repo browser&nbsp;<a href="http://freetts.svn.sourceforge.net/viewvc/freetts/" style="color: #3465a4;">http://freetts.svn.sourceforge.net/viewvc/freetts/</a>&nbsp;, svn http access&nbsp;<a href="https://freetts.svn.sourceforge.net/svnroot/freetts/" style="color: #3465a4;">https://freetts.svn.sourceforge.net/svnroot/freetts/</a><br />At time of writing the current svn revision is 582.</div><div><br /></div><div>The latest packaged version for ubuntu:<br /><blockquote class="tr_bq"><b>apt-cache show freetts</b>Package: freetts<br />Priority: optional<br />Section: universe/java<br />Installed-Size: 13532<br />Maintainer: Ubuntu Developers &lt;<a href="http://www.blogger.com/ubuntu-devel-discuss@lists.ubuntu.com%3E" style="color: #3465a4;">ubuntu-devel-discuss@lists.ubuntu.com&gt;</a>Original-Maintainer: Bdale Garbee &lt;<a href="http://www.blogger.com/bdale@gag.com%3E" style="color: #3465a4;">bdale@gag.com&gt;</a>Architecture: all<br /><b>Version: 1.2.2-3</b>Depends: default-jre | java2-runtime<br />Filename: pool/universe/f/freetts/freetts_1.2.2-3_all.deb<br />Size: 9456904<br />MD5sum: 183bed09b1b8e2d8642f46b7538273f4<br />SHA1: 8df47df82124704b890f446a1bc958d33fd273d3<br />SHA256: 8920440eaa58c087cb268e8e2a64d44ac873fb44d49b34f180f587f9c69421a7<br />Description-en: speech synthesis system<br />FreeTTS is a speech synthesis system written entirely in the Java(TM)<br />programming language.  It is based upon Flite, a small run-time speech<br />synthesis engine developed at Carnegie Mellon University.  Flite in turn<br />is derived from the Festival Speech Synthesis System from the University<br />of Edinburgh and the FestVox project from Carnegie Mellon University.<br />Homepage: <a href="http://freetts.sourceforge.net/" style="color: #3465a4;">http://freetts.sourceforge.net</a>Description-md5: a346fe6dcc2c0164ec6b7c3891945e56<br />Bugs: <a href="https://bugs.launchpad.net/ubuntu/+filebug" style="color: #3465a4;">https://bugs.launchpad.net/ubuntu/+filebug</a>Origin: Ubuntu</blockquote><br /><br />So here's the import more or less as it happened:<br /><br />mkdir freetts.svn.git; cd freetts.svn.git<br />svn2git --verbose <a href="https://freetts.svn.sourceforge.net/svnroot/freetts/" style="color: #3465a4;">https://freetts.svn.sourceforge.net/svnroot/freetts/</a><br />git gc<br /><br />cat .git/config <br /><blockquote class="tr_bq">[core]<br />&nbsp;repositoryformatversion = 0<br />&nbsp;filemode = true<br />&nbsp;bare = false<br />&nbsp;logallrefupdates = true<br />[svn-remote "svn"]<br />&nbsp;noMetadata = 1<br />&nbsp;url = <a href="https://freetts.svn.sourceforge.net/svnroot/freetts" style="color: #3465a4;">https://freetts.svn.sourceforge.net/svnroot/freetts</a>&nbsp;fetch = trunk:refs/remotes/svn/trunk<br />&nbsp;branches = branches/*:refs/remotes/svn/*<br />&nbsp;tags = tags/*:refs/remotes/svn/tags/*<br />[branch "release"]<br />&nbsp;remote = .<br />&nbsp;merge = refs/remotes/svn/release</blockquote><br /><br /># get a copy without the svn references (which stop us seeing whether the rewritten history is free of old cruft)</div><div>cd ..<br />git clone freetts.svn.git/ freetts.git<br />cd freetts.git/<br />gitk --all &amp;<br /><b># The following is done while keeping an eye on and refreshing (ctrl+f5) gitk to see the effects:</b><br /># Filter out the cvs rubbish so that git can match up commits that do have it with commits that don't<br />git filter-branch --tree-filter 'rm -rf CVSROOT' --prune-empty -- --all<br /># Remove the unnecessary top level folder (which inconsistently existed)<br />git filter-branch --prune-empty --subdirectory-filter FreeTTS/ -- --all<br /># Remove the backup refs filter-branch creates<br />rm -rf .git/refs/original/<br /><br /># delete all the crappy svn "tags", just tag the latest<br />git tag -d `git tag`<br /><blockquote class="tr_bq">Deleted tag 'freetts' (was 8d953b7)<br />Deleted tag 'pre-rel1-1' (was d1c597f)<br />Deleted tag 'rel1_1_0' (was 625abdd)<br />Deleted tag 'rel1_1_2' (was b51fb71)<br />Deleted tag 'rel1_2_0' (was 7a4fc18)<br />Deleted tag 'rel1_2_1' (was a126a4a)<br />Deleted tag 'rel1_2_2' (was b3a0dcf)<br />Deleted tag 'rel1_2_2@557' (was bf94dbe)<br />Deleted tag 'rel1_2beta2' (was c0d90e9)<br />Deleted tag 'rel_1_0_5' (was e95aff8)<br />Deleted tag 'rel_1_2_beta' (was 1723b2d)<br />Deleted tag 'start' (was c020efe)<br />Deleted tag 'sun' (was cfadbc8)</blockquote><br /># correct commit found manually:<br />git tag v1.2.2 ae49425<br /><br />and finally, push to github<br /><br />git remote add origin .... (my repo details)<br />git push --mirror<br /><br />You can find my repo at&nbsp;<a href="https://github.com/timabell/FreeTTS">https://github.com/timabell/FreeTTS</a><br />and the intermediate copy here:&nbsp;<a href="https://github.com/timabell/FreeTTS-svn-mirror">https://github.com/timabell/FreeTTS-svn-mirror</a><br /><br /><div style="text-align: center;"><i>All done</i></div><div style="text-align: center;"><i><br /></i></div><div style="text-align: center;"><i>^_^</i></div><div><br /></div><div><br /></div><br />Here's the reason I didn't bother with tags in the end: I couldn't rewrite the tags as they had no author:<br /><br />git filter-branch --tree-filter 'rm -rf CVSROOT' --prune-empty --tag-name-filter cat -- --tags<br />Cannot create a new backup.  <br />A previous backup already exists in refs/original/<br />Force overwriting the backup with -f<br /><a href="http://www.blogger.com/tim@atom:~/repo/freetts.git$" style="color: #3465a4;">tim@atom:~/repo/freetts.git$</a> rm -rf .git/refs/original/                                <br /><a href="http://www.blogger.com/tim@atom:~/repo/freetts.git$" style="color: #3465a4;">tim@atom:~/repo/freetts.git$</a> git filter-branch --tree-filter 'rm -rf CVSROOT' --prune-empty --tag-name-filter cat -- --tags<br />Rewrite 8611e271692fc33e6160a2a217b9b3060dfbcd1d (1044/1044)<br />Ref 'refs/tags/freetts' was rewritten<br />WARNING: Ref 'refs/tags/pre-rel1-1' is unchanged<br />WARNING: Ref 'refs/tags/rel1_1_0' is unchanged<br />Ref 'refs/tags/rel1_1_2' was rewritten<br />Ref 'refs/tags/rel1_2_0' was rewritten<br />Ref 'refs/tags/rel1_2_1' was rewritten<br />Ref 'refs/tags/rel1_2_2' was rewritten<br />Ref 'refs/tags/rel1_2_2@557' was rewritten<br />Ref 'refs/tags/rel1_2beta2' was rewritten<br />Ref 'refs/tags/rel_1_0_5' was rewritten<br />Ref 'refs/tags/rel_1_2_beta' was rewritten<br />Ref 'refs/tags/start' was rewritten<br />Ref 'refs/tags/sun' was rewritten<br />freetts -&gt; freetts (b3a4bbf8768ade6275c91ce0e76d933e30b3ddbf -&gt; 48e84e3560e765db3b33479e2e9a76fe2ccf3550)<br /><b>error: char79: malformed tagger field<br />fatal: invalid tag signature file<br />Could not create new tag object for freetts</b><br /><b><br /></b><b><br /></b>git show rel_1_2_beta | head<br />tag rel_1_2_beta<br /><b>Tagger: (no author) &lt;(no author)@4963320b-1a4a-0410-81c8-f0a525965860&gt;</b>Date:   Mon Dec 22 14:46:05 2003 +0000<br /><br />This commit was manufactured by cvs2svn to create tag '\''rel_1_2_beta'\''.<br /><br />commit 57ed00e981585aad590c9521d7c3a0bccf6284fa<br />Author: (no author) &lt;(no author)@4963320b-1a4a-0410-81c8-f0a525965860&gt;<br />Date:   Mon Dec 22 14:46:05 2003 +0000</div><div><br /></div><div>------</div><div><br /></div><div>My advice if you are importing svn for a commercial project: Don't! Just export, and import into your new source control tool. Leave the svn repo read only for a while just in case you need that history, and after a year of never looking back, archive it off.</div>